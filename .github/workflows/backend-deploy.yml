name: Backend Deploy via ECR

on:
  push:
    branches: [main]
    paths: ['backend/**']
  workflow_dispatch:

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd backend
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_ENV

    - name: Deploy to Auto Scaling Group via Instance Refresh
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY_NAME }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Get ASG name
        ASG_NAME="${{ secrets.ASG_NAME }}"
        
        if [ -z "$ASG_NAME" ]; then
          echo "‚ùå No ASG name found"
          exit 1
        fi
        
        IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo "üöÄ Deploying image $IMAGE_URI to ASG: $ASG_NAME"
        
        # Get current launch template
        LAUNCH_TEMPLATE_ID=$(aws autoscaling describe-auto-scaling-groups \
          --auto-scaling-group-names $ASG_NAME \
          --query 'AutoScalingGroups[0].LaunchTemplate.LaunchTemplateId' \
          --output text)
        
        if [ "$LAUNCH_TEMPLATE_ID" = "None" ] || [ -z "$LAUNCH_TEMPLATE_ID" ]; then
          echo "‚ùå No launch template found for ASG $ASG_NAME"
          exit 1
        fi
        
        echo "üìã Launch Template ID: $LAUNCH_TEMPLATE_ID"
        
        # Create new launch template version with updated user data
        NEW_VERSION=$(aws ec2 create-launch-template-version \
          --launch-template-id $LAUNCH_TEMPLATE_ID \
          --source-version '$Latest' \
          --launch-template-data '{
            "UserData": "'$(echo "#!/bin/bash
set -e

# Update system
sudo apt-get update

# Install Docker if not present
if ! command -v docker &> /dev/null; then
    sudo apt-get install -y docker.io
    sudo systemctl start docker
    sudo systemctl enable docker
    sudo usermod -aG docker ubuntu
fi

# Install AWS CLI if not present
if ! command -v aws &> /dev/null; then
    sudo apt-get install -y awscli
fi

# Login to ECR and deploy
aws ecr get-login-password --region ap-southeast-1 | sudo docker login --username AWS --password-stdin $ECR_REGISTRY
sudo docker stop \$(sudo docker ps -q) || true
sudo docker rm \$(sudo docker ps -aq) || true
sudo docker pull $IMAGE_URI
sudo docker run -d --name jagasewa-backend -p 80:80 --restart unless-stopped -e AWS_DEFAULT_REGION=ap-southeast-1 -e DB_SECRET_NAME=jagasewa-db-credentials-prod $IMAGE_URI
sudo docker system prune -f" | base64 -w 0)'"
          }' \
          --query 'LaunchTemplateVersion.VersionNumber' \
          --output text)
        
        echo "üìã New Launch Template Version: $NEW_VERSION"
        
        # Start instance refresh
        REFRESH_ID=$(aws autoscaling start-instance-refresh \
          --auto-scaling-group-name $ASG_NAME \
          --preferences '{
            "InstanceWarmup": 300,
            "MinHealthyPercentage": 50,
            "CheckpointPercentages": [50, 100],
            "CheckpointDelay": 600
          }' \
          --query 'InstanceRefreshId' \
          --output text)
        
        echo "üîÑ Instance Refresh ID: $REFRESH_ID"
        echo "‚è≥ Waiting for instance refresh to complete..."
        
        # Wait for instance refresh completion
        for i in {1..60}; do
          STATUS=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name $ASG_NAME \
            --instance-refresh-ids $REFRESH_ID \
            --query 'InstanceRefreshes[0].Status' \
            --output text)
          
          PERCENTAGE=$(aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name $ASG_NAME \
            --instance-refresh-ids $REFRESH_ID \
            --query 'InstanceRefreshes[0].PercentageComplete' \
            --output text)
          
          echo "‚è≥ Instance refresh status: $STATUS ($PERCENTAGE% complete) - ($i/60)"
          
          if [ "$STATUS" = "Successful" ]; then
            echo "‚úÖ Instance refresh completed successfully"
            break
          elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ]; then
            echo "‚ùå Instance refresh failed with status: $STATUS"
            exit 1
          fi
          
          sleep 30
        done
        
        # Final status check
        FINAL_STATUS=$(aws autoscaling describe-instance-refreshes \
          --auto-scaling-group-name $ASG_NAME \
          --instance-refresh-ids $REFRESH_ID \
          --query 'InstanceRefreshes[0].Status' \
          --output text)
        
        if [ "$FINAL_STATUS" != "Successful" ]; then
          echo "‚ùå Instance refresh did not complete successfully. Final status: $FINAL_STATUS"
          exit 1
        fi
        
        echo "‚úÖ Deployment completed successfully to ASG: $ASG_NAME"